<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>mcsBuilder — Stage 06 Final Build</title>
  <meta name="author" content="Tiger Fang" />
  <meta name="description" content="Final self-contained build of the mcsBuilder prototype for course submission." />
  <meta name="course" content="Interactive Computing Studio" />
  <style>
    :root {
      --bg: #0f1321;
      --panel-bg: #1d1e2b;
      --panel-border: #3a3d55;
      --text: #f5f5f8;
      --accent: #6bd3ff;
      --hud-bg: rgba(12, 14, 24, 0.92);
      --bubble-bg: rgba(20, 20, 30, 0.95);
      font-size: 16px;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      color: var(--text);
      font-family: "Press Start 2P", "VT323", "Courier New", monospace;
    }

    body.high-contrast {
      --bg: #050505;
      --panel-bg: #000000;
      --panel-border: #ffffff;
      --text: #ffffff;
      --hud-bg: rgba(0, 0, 0, 0.92);
      --bubble-bg: rgba(0, 0, 0, 0.95);
    }

    h1, h2, h3 {
      font-size: 1rem;
      letter-spacing: 0.05em;
      margin: 0 0 0.75rem;
    }

    .hud {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 0.75rem 1.25rem;
      background: var(--hud-bg);
      border-bottom: 2px solid var(--panel-border);
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      box-sizing: border-box;
    }

    .hud-item {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .hud-item .label {
      opacity: 0.75;
    }

    .hud-item .value {
      color: var(--accent);
      font-size: 0.8rem;
    }

    .hud-item.bar-item {
      gap: 0.4rem;
    }

    .bar {
      position: relative;
      height: 22px;
      border: 2px solid var(--panel-border);
      background: rgba(10, 14, 24, 0.7);
      overflow: hidden;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.08);
    }

    .bar .fill {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 0%;
      background: linear-gradient(90deg, #67f3a2, #2db4ff);
      transition: width 0.25s ease-out;
    }

    .bar .bar-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.65rem;
      color: var(--text);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
      pointer-events: none;
    }

    .main-wrapper {
      display: flex;
      flex: 1;
      gap: 1.5rem;
      padding: 1.5rem;
      box-sizing: border-box;
    }

    canvas {
      border: 3px solid var(--panel-border);
      background: #10181f;
      flex-shrink: 0;
    }

    .panel {
      width: 260px;
      background: var(--panel-bg);
      border: 3px solid var(--panel-border);
      padding: 1.25rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: fit-content;
    }

    body.game-complete canvas {
      filter: grayscale(0.25) brightness(0.82);
    }

    #winOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(5, 7, 12, 0.76);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 40;
    }

    #winOverlay.show {
      opacity: 1;
      pointer-events: all;
    }

    #winOverlay .win-panel {
      background: rgba(16, 18, 32, 0.95);
      border: 3px solid var(--panel-border);
      padding: 2rem 2.5rem;
      text-align: center;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.45);
      width: min(90vw, 420px);
    }

    #winOverlay .win-panel h2 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      letter-spacing: 0.1em;
    }

    #winOverlay .win-panel p {
      font-size: 0.85rem;
      margin: 0 0 1.25rem;
      color: rgba(245, 245, 248, 0.85);
    }

    #winOverlay .win-panel button {
      width: auto;
      padding: 0.75rem 1.5rem;
      font-size: 0.85rem;
    }

    .panel button {
      width: 100%;
      padding: 0.75rem;
      background: transparent;
      color: var(--text);
      border: 2px solid var(--panel-border);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      transition: background 0.2s ease;
    }

    .panel button:hover,
    .panel button:focus {
      background: rgba(255, 255, 255, 0.08);
      outline: none;
    }

    .panel .worker-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .worker-card {
      border: 2px solid var(--panel-border);
      background: rgba(12, 14, 24, 0.6);
      border-radius: 8px;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .worker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .worker-header h3 {
      margin: 0;
      font-size: 0.75rem;
    }

    .worker-header .order-label {
      font-size: 0.6rem;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.08);
    }

    .worker-card .summary {
      font-size: 0.6rem;
      line-height: 1.4;
      color: rgba(245, 245, 248, 0.8);
    }

    .worker-actions {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.4rem;
    }

    .worker-actions button {
      font-size: 0.6rem;
      padding: 0.45rem 0.2rem;
      text-transform: uppercase;
    }

    .worker-actions button.active {
      background: rgba(103, 243, 162, 0.18);
      border-color: #67f3a2;
      color: #67f3a2;
    }

    .fsm-log {
      margin-top: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .fsm-log h3 {
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      margin: 0;
    }

    #fsmLog {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 160px;
      overflow-y: auto;
      border: 2px solid var(--panel-border);
      background: rgba(12, 14, 24, 0.6);
      border-radius: 8px;
    }

    #fsmLog li {
      font-size: 0.55rem;
      padding: 0.45rem 0.6rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    #fsmLog li:last-child {
      border-bottom: none;
    }

    #textBubble {
      position: absolute;
      transform: translate(-50%, -110%);
      background: var(--bubble-bg);
      border: 2px solid #fce38a;
      padding: 0.6rem 0.9rem;
      border-radius: 6px;
      font-size: 0.74rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      max-width: 280px;
      text-align: center;
      display: none;
      pointer-events: none;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.55), 0 0 12px rgba(252, 227, 138, 0.35);
      z-index: 20;
    }

    .panel .status {
      font-size: 0.65rem;
      line-height: 1.4;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="hud">
    <div class="hud-item bar-item">
      <span class="label">Wood Stock</span>
      <div class="bar" id="woodBar">
        <div class="fill" id="woodFill"></div>
        <span class="bar-text" id="woodText">0</span>
      </div>
    </div>
    <div class="hud-item bar-item">
      <span class="label">Campus Progress</span>
      <div class="bar" id="progressBar">
        <div class="fill" id="progressFill"></div>
        <span class="bar-text" id="progressText">0%</span>
      </div>
    </div>
    <div class="hud-item">
      <span class="label">Floors Complete</span>
      <span class="value" id="hud-floors">0 / 10</span>
    </div>
    <div class="hud-item">
      <span class="label">Current Floor</span>
      <span class="value" id="hud-floor">1</span>
    </div>
    <div class="hud-item">
      <span class="label">Total Time</span>
      <span class="value" id="hud-time">00:00</span>
    </div>
    <div class="hud-item">
      <span class="label">Delivery Level</span>
      <span class="value" id="hud-delivery">L1 · 5 SP</span>
    </div>
  </div>
  <div class="main-wrapper">
    <canvas id="gameCanvas" width="1140" height="600" aria-label="mcsBuilder stage 06 playfield"></canvas>
    <aside class="panel" aria-label="control panel">
      <h2>Control Panel</h2>
      <button id="pauseBtn" type="button">Pause</button>
      <button id="speedBtn" type="button">Speed: 1×</button>
      <button id="contrastBtn" type="button">Contrast</button>
      <section class="worker-group" aria-label="worker commands">
        <div class="worker-card" data-worker="builder">
          <div class="worker-header">
            <h3>Builder</h3>
            <span class="order-label">Idle</span>
          </div>
          <p class="summary">
            Stamina: <span class="stamina">5.0</span> / <span class="stamina-max">5</span>
            · Level <span class="level">1</span>
            · State: <span class="state">idle</span>
          </p>
          <div class="worker-actions">
            <button type="button" data-action="build">Build</button>
            <button type="button" data-action="rest">Rest</button>
            <button type="button" data-action="cancel">Cancel</button>
          </div>
        </div>
        <div class="worker-card" data-worker="delivery">
          <div class="worker-header">
            <h3>Delivery</h3>
            <span class="order-label">Idle</span>
          </div>
          <p class="summary">
            Stamina: <span class="stamina">5.0</span> / <span class="stamina-max">5</span>
            · Level <span class="level">1</span>
            · State: <span class="state">idle</span>
          </p>
          <div class="worker-actions">
            <button type="button" data-action="fetch">Fetch</button>
            <button type="button" data-action="rest">Rest</button>
            <button type="button" data-action="cancel">Cancel</button>
          </div>
        </div>
      </section>
      <section class="fsm-log" aria-label="worker state log">
        <h3>Worker State Log</h3>
        <ul id="fsmLog" aria-live="polite"></ul>
      </section>
      <p class="status" id="panelStatus">Awaiting input…</p>
    </aside>
  </div>
  <div id="winOverlay" role="dialog" aria-modal="true" aria-labelledby="winTitle">
    <div class="win-panel">
      <h2 id="winTitle">Construction Complete!</h2>
      <p>Total Time: <span id="winTime">00:00</span></p>
      <button id="restartBtn" type="button">Restart Project</button>
    </div>
  </div>
  <div id="textBubble" role="status" aria-live="polite"></div>
  <script>
    // Core references to the DOM so we avoid repeated lookups during the render loop.
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const woodFill = document.getElementById('woodFill');
    const woodText = document.getElementById('woodText');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const hudFloors = document.getElementById('hud-floors');
    const hudFloor = document.getElementById('hud-floor');
    const hudTime = document.getElementById('hud-time');
    const hudDelivery = document.getElementById('hud-delivery');
    const panelStatus = document.getElementById('panelStatus');
    const fsmLog = document.getElementById('fsmLog');
    const bubbleEl = document.getElementById('textBubble');
    const winOverlay = document.getElementById('winOverlay');
    const winTime = document.getElementById('winTime');

    // Zones are the important locations the workers travel between.
    const zones = {
      site: { x: 860, y: 300 },
      wood: { x: 200, y: 420 },
      dorm: { x: 320, y: 180 }
    };

    // Game level configuration so the numbers are easy to tweak.
    const config = {
      totalFloors: 10,
      woodCapacity: 60,
      builder: {
        staminaMax: 5,
        travelSpeed: 110,
        restRate: 0.8,
        staminaCost: 0.6,
        buildRate: 18,
        woodUseRate: 0.3
      },
      delivery: {
        staminaMax: 5,
        travelSpeed: 120,
        restRate: 0.7,
        staminaCost: 0.45,
        loadTime: 2.2,
        dropRate: 6,
        batchSize: 6
      }
    };

    const world = {
      wood: 12,
      floorProgress: 0,
      floorsComplete: 0,
      currentFloor: 1,
      timeElapsed: 0,
      paused: false,
      speed: 1,
      bubbleTimer: 0
    };

    const builder = {
      id: 'builder',
      label: 'Builder',
      x: zones.dorm.x,
      y: zones.dorm.y,
      width: 22,
      height: 22,
      color: '#f6d365',
      stamina: config.builder.staminaMax,
      level: 1,
      state: 'idle',
      order: 'Idle',
      target: null,
      staminaMax: config.builder.staminaMax,
      activeAction: null,
      stateTime: 0
    };

    const delivery = {
      id: 'delivery',
      label: 'Delivery',
      x: zones.dorm.x + 30,
      y: zones.dorm.y,
      width: 22,
      height: 22,
      color: '#8ed1fc',
      stamina: config.delivery.staminaMax,
      level: 1,
      state: 'idle',
      order: 'Idle',
      target: null,
      staminaMax: config.delivery.staminaMax,
      activeAction: null,
      stateTime: 0,
      carry: 0
    };

    const workers = [builder, delivery];

    const workerCards = {
      builder: document.querySelector('.worker-card[data-worker="builder"]'),
      delivery: document.querySelector('.worker-card[data-worker="delivery"]')
    };

    // Utility helpers -------------------------------------------------------
    function woodNeededForFloor(floor) {
      return 12 + (floor - 1) * 4;
    }

    function clamp(value, min, max) {
      if (value < min) {
        return min;
      }
      if (value > max) {
        return max;
      }
      return value;
    }

    function formatTime(seconds) {
      const total = Math.floor(seconds);
      const mins = String(Math.floor(total / 60)).padStart(2, '0');
      const secs = String(total % 60).padStart(2, '0');
      return `${mins}:${secs}`;
    }

    function logState(worker, message) {
      const li = document.createElement('li');
      li.textContent = `${worker.label}: ${message}`;
      fsmLog.prepend(li);
      while (fsmLog.children.length > 12) {
        fsmLog.removeChild(fsmLog.lastChild);
      }
    }

    function setPanelStatus(message) {
      panelStatus.textContent = message;
    }

    function setWorkerState(worker, state, orderLabel) {
      worker.state = state;
      worker.order = orderLabel || state;
      worker.stateTime = 0;
      logState(worker, worker.order);
      updateWorkerCard(worker);
    }

    function setWorkerTarget(worker, point) {
      worker.target = { x: point.x, y: point.y };
    }

    function showBubble(text, worker) {
      bubbleEl.textContent = text;
      const rect = canvas.getBoundingClientRect();
      const scaleX = rect.width / canvas.width;
      const scaleY = rect.height / canvas.height;
      const x = rect.left + worker.x * scaleX;
      const y = rect.top + worker.y * scaleY;
      bubbleEl.style.left = `${x}px`;
      bubbleEl.style.top = `${y}px`;
      bubbleEl.style.display = 'block';
      world.bubbleTimer = 2.4;
    }

    function hideBubble() {
      bubbleEl.style.display = 'none';
    }

    function updateWorkerCard(worker) {
      const card = workerCards[worker.id];
      card.querySelector('.order-label').textContent = worker.order;
      card.querySelector('.stamina').textContent = worker.stamina.toFixed(1);
      card.querySelector('.stamina-max').textContent = worker.staminaMax;
      card.querySelector('.level').textContent = worker.level;
      card.querySelector('.state').textContent = worker.state;
      const buttons = card.querySelectorAll('button');
      buttons.forEach(button => {
        const isActive = button.dataset.action === worker.activeAction;
        if (isActive) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
    }

    function updateHud() {
      const requirement = woodNeededForFloor(world.currentFloor);
      const progressValue = (world.floorsComplete + world.floorProgress / requirement) / config.totalFloors;
      const woodRatio = world.wood / config.woodCapacity;
      woodFill.style.width = `${Math.min(1, woodRatio) * 100}%`;
      woodText.textContent = `${Math.round(world.wood)} / ${config.woodCapacity}`;
      progressFill.style.width = `${Math.min(1, progressValue) * 100}%`;
      progressText.textContent = `${Math.round(progressValue * 100)}%`;
      hudFloors.textContent = `${world.floorsComplete} / ${config.totalFloors}`;
      hudFloor.textContent = world.currentFloor;
      hudTime.textContent = formatTime(world.timeElapsed);
      hudDelivery.textContent = `L${delivery.level} · ${delivery.stamina.toFixed(1)} SP`;
    }

    function updatePanelStatusForAction(worker, action) {
      const friendly = `${worker.label} → ${action}`;
      setPanelStatus(friendly);
    }

    // Worker commands -------------------------------------------------------
    function commandBuilder(action) {
      if (action === 'build') {
        builder.activeAction = 'build';
        setWorkerTarget(builder, zones.site);
        setWorkerState(builder, 'headingToSite', 'Heading to Site');
        updatePanelStatusForAction(builder, 'Build');
        return;
      }
      if (action === 'rest') {
        builder.activeAction = 'rest';
        setWorkerTarget(builder, zones.dorm);
        setWorkerState(builder, 'headingToDorm', 'Heading to Dorm');
        updatePanelStatusForAction(builder, 'Rest');
        return;
      }
      if (action === 'cancel') {
        builder.activeAction = null;
        builder.target = null;
        setWorkerState(builder, 'idle', 'Idle');
        updatePanelStatusForAction(builder, 'Cancel');
      }
    }

    function commandDelivery(action) {
      if (action === 'fetch') {
        delivery.activeAction = 'fetch';
        setWorkerTarget(delivery, zones.wood);
        setWorkerState(delivery, 'headingToWood', 'Heading to Wood Lot');
        updatePanelStatusForAction(delivery, 'Fetch');
        return;
      }
      if (action === 'rest') {
        delivery.activeAction = 'rest';
        setWorkerTarget(delivery, zones.dorm);
        setWorkerState(delivery, 'headingToDorm', 'Heading to Dorm');
        updatePanelStatusForAction(delivery, 'Rest');
        return;
      }
      if (action === 'cancel') {
        delivery.activeAction = null;
        delivery.target = null;
        setWorkerState(delivery, 'idle', 'Idle');
        updatePanelStatusForAction(delivery, 'Cancel');
      }
    }

    // Movement helpers ------------------------------------------------------
    function moveWorker(worker, delta, speed) {
      if (!worker.target) {
        return false;
      }
      const dx = worker.target.x - worker.x;
      const dy = worker.target.y - worker.y;
      const distance = Math.hypot(dx, dy);
      if (distance < 2) {
        worker.x = worker.target.x;
        worker.y = worker.target.y;
        worker.target = null;
        return true;
      }
      const travel = speed * delta;
      const ratio = travel / distance;
      if (ratio >= 1) {
        worker.x = worker.target.x;
        worker.y = worker.target.y;
        worker.target = null;
        return true;
      }
      worker.x += dx * ratio;
      worker.y += dy * ratio;
      return false;
    }

    function adjustStamina(worker, amount, max) {
      worker.stamina = clamp(worker.stamina + amount, 0, max);
    }

    // Builder update --------------------------------------------------------
    function updateBuilder(delta) {
      builder.stateTime += delta;
      if (builder.state === 'headingToSite') {
        const arrived = moveWorker(builder, delta, config.builder.travelSpeed);
        adjustStamina(builder, -config.builder.staminaCost * delta * 0.5, builder.staminaMax);
        if (arrived) {
          setWorkerState(builder, 'building', 'Building Floor');
          showBubble('Hammer time!', builder);
        }
        return;
      }
      if (builder.state === 'building') {
        if (world.wood <= 0) {
          showBubble('Need more wood!', builder);
          setWorkerState(builder, 'idle', 'Waiting for Supplies');
          builder.activeAction = null;
          return;
        }
        adjustStamina(builder, -config.builder.staminaCost * delta, builder.staminaMax);
        const spendRate = config.builder.woodUseRate * delta;
        const woodSpent = Math.min(world.wood, spendRate);
        world.wood -= woodSpent;
        let spendRatio = 0;
        if (spendRate > 0) {
          spendRatio = woodSpent / spendRate;
        }
        world.floorProgress += config.builder.buildRate * delta * spendRatio;
        if (builder.stamina <= 0) {
          setWorkerTarget(builder, zones.dorm);
          setWorkerState(builder, 'headingToDorm', 'Out of Stamina');
          builder.activeAction = 'rest';
          return;
        }
        const requirement = woodNeededForFloor(world.currentFloor);
        if (world.floorProgress >= requirement) {
          world.floorsComplete += 1;
          world.floorProgress = 0;
          world.currentFloor = Math.min(config.totalFloors, world.floorsComplete + 1);
          showBubble('Floor complete!', builder);
          if (world.floorsComplete >= config.totalFloors) {
            finishGame();
          }
        }
        return;
      }
      if (builder.state === 'headingToDorm') {
        const arrivedDorm = moveWorker(builder, delta, config.builder.travelSpeed);
        if (arrivedDorm) {
          setWorkerState(builder, 'resting', 'Recovering');
        }
        return;
      }
      if (builder.state === 'resting') {
        adjustStamina(builder, config.builder.restRate * delta, builder.staminaMax);
        if (builder.stamina >= builder.staminaMax) {
          builder.stamina = builder.staminaMax;
          setWorkerState(builder, 'idle', 'Ready');
          builder.activeAction = null;
          showBubble('Builder rested.', builder);
        }
      }
    }

    // Delivery update -------------------------------------------------------
    function updateDelivery(delta) {
      delivery.stateTime += delta;
      if (delivery.state === 'headingToWood') {
        const arrived = moveWorker(delivery, delta, config.delivery.travelSpeed);
        adjustStamina(delivery, -config.delivery.staminaCost * delta, delivery.staminaMax);
        if (arrived) {
          setWorkerState(delivery, 'loading', 'Gathering Supplies');
          delivery.stateTime = 0;
        }
        return;
      }
      if (delivery.state === 'loading') {
        if (delivery.stateTime >= config.delivery.loadTime) {
          delivery.carry = config.delivery.batchSize;
          setWorkerTarget(delivery, zones.site);
          setWorkerState(delivery, 'headingToSite', 'Returning to Site');
        }
        return;
      }
      if (delivery.state === 'headingToSite') {
        const arrivedSite = moveWorker(delivery, delta, config.delivery.travelSpeed);
        adjustStamina(delivery, -config.delivery.staminaCost * delta, delivery.staminaMax);
        if (arrivedSite) {
          setWorkerState(delivery, 'delivering', 'Drop Off');
        }
        return;
      }
      if (delivery.state === 'delivering') {
        if (delivery.carry <= 0) {
          setWorkerTarget(delivery, zones.wood);
          setWorkerState(delivery, 'headingToWood', 'Heading for More');
          return;
        }
        const dropAmount = Math.min(delivery.carry, config.delivery.dropRate * delta);
        delivery.carry -= dropAmount;
        world.wood = clamp(world.wood + dropAmount, 0, config.woodCapacity);
        return;
      }
      if (delivery.state === 'headingToDorm') {
        const arrivedDorm = moveWorker(delivery, delta, config.delivery.travelSpeed);
        if (arrivedDorm) {
          setWorkerState(delivery, 'resting', 'Recovering');
        }
        return;
      }
      if (delivery.state === 'resting') {
        adjustStamina(delivery, config.delivery.restRate * delta, delivery.staminaMax);
        if (delivery.stamina >= delivery.staminaMax) {
          delivery.stamina = delivery.staminaMax;
          setWorkerState(delivery, 'idle', 'Ready');
          delivery.activeAction = null;
          showBubble('Delivery rested.', delivery);
        }
      }
    }

    // Rendering -------------------------------------------------------------
    function drawScene() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGround();
      drawZones();
      drawBuilding();
      drawWorkers();
    }

    function drawGround() {
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#152036');
      gradient.addColorStop(1, '#0b121d');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#1d2a3e';
      for (let x = 0; x < canvas.width; x += 40) {
        ctx.fillRect(x, 0, 1, canvas.height);
      }
      for (let y = 0; y < canvas.height; y += 40) {
        ctx.fillRect(0, y, canvas.width, 1);
      }
    }

    function drawZones() {
      drawZoneCircle(zones.wood.x, zones.wood.y, '#3f8b6b', 'Wood Lot');
      drawZoneCircle(zones.dorm.x, zones.dorm.y, '#7a4bc2', 'Dorms');
      drawZoneCircle(zones.site.x, zones.site.y, '#f77f00', 'Build Site');
    }

    function drawZoneCircle(x, y, color, label) {
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.18;
      ctx.beginPath();
      ctx.arc(x, y, 60, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.fillStyle = '#ffffff';
      ctx.font = '12px "Courier New", monospace';
      ctx.textAlign = 'center';
      ctx.fillText(label, x, y - 70);
    }

    function drawBuilding() {
      const baseX = zones.site.x;
      const baseY = zones.site.y + 120;
      const width = 120;
      const floorHeight = 18;
      ctx.fillStyle = '#2d374f';
      ctx.fillRect(baseX - width / 2, baseY, width, 18);
      for (let i = 0; i < world.floorsComplete; i += 1) {
        const y = baseY - (i + 1) * floorHeight;
        if (i % 2 === 0) {
          ctx.fillStyle = '#5064a1';
        } else {
          ctx.fillStyle = '#6a7dc7';
        }
        ctx.fillRect(baseX - width / 2, y, width, floorHeight - 2);
      }
      const requirement = woodNeededForFloor(world.currentFloor);
      const progressRatio = clamp(world.floorProgress / requirement, 0, 1);
      const y = baseY - (world.floorsComplete + 1) * floorHeight;
      ctx.fillStyle = '#8dd694';
      ctx.fillRect(baseX - width / 2, y, width * progressRatio, floorHeight - 2);
    }

    function drawWorkers() {
      workers.forEach(worker => {
        ctx.fillStyle = worker.color;
        ctx.fillRect(worker.x - worker.width / 2, worker.y - worker.height / 2, worker.width, worker.height);
        ctx.fillStyle = '#050608';
        ctx.font = '10px "Courier New", monospace';
        ctx.textAlign = 'center';
        ctx.fillText(worker.label.charAt(0), worker.x, worker.y + 3);
      });
    }

    // Game loop -------------------------------------------------------------
    let lastTime = 0;
    function gameLoop(timestamp) {
      if (!lastTime) {
        lastTime = timestamp;
      }
      const delta = (timestamp - lastTime) / 1000;
      lastTime = timestamp;
      if (!world.paused) {
        const scaledDelta = delta * world.speed;
        world.timeElapsed += scaledDelta;
        world.bubbleTimer -= scaledDelta;
        if (world.bubbleTimer <= 0) {
          hideBubble();
        }
        updateBuilder(scaledDelta);
        updateDelivery(scaledDelta);
        updateHud();
      }
      drawScene();
      requestAnimationFrame(gameLoop);
    }

    // Win / reset -----------------------------------------------------------
    function finishGame() {
      world.paused = true;
      document.body.classList.add('game-complete');
      winOverlay.classList.add('show');
      winTime.textContent = formatTime(world.timeElapsed);
      setPanelStatus('Campus complete!');
    }

    function resetGame() {
      world.wood = 12;
      world.floorProgress = 0;
      world.floorsComplete = 0;
      world.currentFloor = 1;
      world.timeElapsed = 0;
      world.paused = false;
      world.speed = 1;
      document.getElementById('speedBtn').textContent = 'Speed: 1×';
      document.body.classList.remove('game-complete');
      winOverlay.classList.remove('show');
      builder.x = zones.dorm.x;
      builder.y = zones.dorm.y;
      builder.stamina = builder.staminaMax;
      builder.state = 'idle';
      builder.order = 'Idle';
      builder.target = null;
      builder.activeAction = null;
      delivery.x = zones.dorm.x + 30;
      delivery.y = zones.dorm.y;
      delivery.stamina = delivery.staminaMax;
      delivery.state = 'idle';
      delivery.order = 'Idle';
      delivery.target = null;
      delivery.activeAction = null;
      delivery.carry = 0;
      fsmLog.innerHTML = '';
      hideBubble();
      updateWorkerCard(builder);
      updateWorkerCard(delivery);
      setPanelStatus('Project restarted.');
      updateHud();
    }

    // Button wiring ---------------------------------------------------------
    document.getElementById('pauseBtn').addEventListener('click', () => {
      world.paused = !world.paused;
      if (world.paused) {
        document.getElementById('pauseBtn').textContent = 'Resume';
        setPanelStatus('Simulation paused.');
      } else {
        document.getElementById('pauseBtn').textContent = 'Pause';
        setPanelStatus('Simulation resumed.');
      }
    });

    document.getElementById('speedBtn').addEventListener('click', () => {
      if (world.speed === 1) {
        world.speed = 2;
      } else {
        world.speed = 1;
      }
      document.getElementById('speedBtn').textContent = `Speed: ${world.speed}×`;
      setPanelStatus(`Speed set to ${world.speed}×`);
    });

    document.getElementById('contrastBtn').addEventListener('click', () => {
      document.body.classList.toggle('high-contrast');
    });

    document.getElementById('restartBtn').addEventListener('click', resetGame);

    workerCards.builder.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', () => {
        commandBuilder(button.dataset.action);
      });
    });

    workerCards.delivery.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', () => {
        commandDelivery(button.dataset.action);
      });
    });

    // Start state -----------------------------------------------------------
    resetGame();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
